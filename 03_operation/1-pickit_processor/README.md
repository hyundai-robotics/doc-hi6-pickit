## 3.1. 시험 환경 및 과정  

### 3.1.1 시험 환경

{% hint style="warning" %}
**마스터링 수행 전, `대상 축에 대해` 육안 상으로 `V홈`을 맞추고 `엔코더 오프셋 초기화`를 진행합니다.  
이를 어길 시 `센서 팁 손상`을 초래하거나 `ERROR_VAL_THRESHOLD` 에러 반환을 하게 됩니다.**
{% endhint %}
- 수동 모드, 모터 온 상태에서 동작합니다.
- 동작이 종료될 때까지 반드시 `이네이블 스위치`를 잡아 주어야합니다.
- 엔코더 오프셋 수치를 확인하거나 보정하는 경우 `엔지니어 모드(R: 314)`가 필요합니다. 

<br>
<br>

### 3.1.2 시험 과정 - 요약
1. `관리자모드 (R버튼 + 314)` 진입
2. `마스터링 대상 축`에 대해 **<u>육안으로</u>** V홈을 조그로 맞춘 다음 `엔코더 오프셋` 보정 진행 (아래 3.1.3.1 참조)  
    - 해당 축이 만약 마스터링 플러그인의 `1.인코더 오프셋 이동` 을 누르고 센서 체결 시, 팁이 V홈 근처에 위치하면 5.부터 진행해도 됩니다.
3. 마스터링 센서 `체결`
4. `마스터링 플러그인` 진입  
5. [대기 화면](../../02_about_kit/3-com_initialization/README.md)에서 `마스터링 대상 축 번호` 입력 후 `확인` 
6. `마스터링 플러그인` 재진입
7. 모터온 후 `1.인코더 오프셋 이동` 버튼 클릭 (2.의 보정된 엔코더 오프셋 위치로 이동하게 됨)
8. V홈 근처에 센서 팁이 위치했는지 확인 후 `2.마스터링 시작` 버튼 클릭
9. 완료 시 `확인` 클릭. 추가로 마스터링 해야하는 축이 있을 시 센서 탈착 후 2. 부터 재진행 
10. [`필수`] 전 축 마스터링 완료 후 아래 과정으로 보정된 엔코더 오프셋 값들을 제어기에 적용 및 저장
    - `시스템` > `3: 로봇 파라미터` > `4: 엔코더 옵셋` > `shift + 확인` > `확인`
11. 마스터링 후 보정된 엔코더 옵셋 보정 여부 확인

<br>
<br>


### 3.1.3 시험 과정 - 상세

<br>

**3.1.3.1. `육안`으로 엔코더 오프셋 보정**
- 1-a) 해당 과정은 초기 엔코더 오프셋의 위치를 V홈 주변으로 설정하여 센서 파손을 방지합니다.<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
현재 엔코더 옵셋으로 `로봇이동`을 하여 센서 팁을 장착하였을 때 V홈 근처에 오면 해당 과정을 생략해도 됩니다.
- 1-c) TP로 직접 조그를 하여 마스터링 대상이 되는 축에 대해 V홈 또는 로봇에 장착된 스케일 바를 맞춰줍니다.
- 1-d) 전 축에 대해서 위치 조정이 완료 되면 `수동으로 엔코더 오프셋 보정`을 진행합니다.  
    - 축 별 하나씩 엔코더 오프셋 보정 시  
    : `시스템` > `3: 로봇 파라미터` > `4: 엔코더 옵셋` > 현재 축의 `보정된 엔코더 값` 클릭 > `단일 초기화` 클릭 > `확인`
    - 전 축 동시에 엔코더 오프셋 보정 시  
    : `시스템` > `3: 로봇 파라미터` > `4: 엔코더 옵셋` > `전체 초기화` 클릭 > `확인`


<br>  
  
**3.1.3.2. 마스터링 키트 장착**
    <div>
    <img src="../../_assets/00_mastering_Vdent_render.png" style="max-height: 20vh; max-width: 15vw">
    <img src="../../_assets/01_mastering_real_picture.png" style="max-height: 20vh; max-width: 12.3vw"><br>Fig 1-1. 마스터링 키트 장착 예시 (좌측: 렌더 이미지, 우측: 실제 체결 이미지)
    </div>  

<br>

**3.1.3.3. `마스터링 기반` 엔코더 오프셋 보정**
- 3-a) 1.의 과정을 마친 후, 마스터링 플러그인에 들어가서 `1.인코더 오프셋 이동` 버튼을 클릭합니다.
- 3-b) 육안으로 맞춘 V홈에 맞게 로봇이 이동한 것을 확인하고 `2. 마스터링 시작` 버튼을 클릭합니다.
- 3-c) 마스터링 진행 시 하기 과정들이 진행됩니다.  
    > c.1) `시작점` 이동: 현재 위치를 기준으로 `-1.5도` 지점을 시작점으로 설정해 움직입니다.  
    > c.2) `도착점` 설정: 시작점을 기준으로 `+3.0도` 지점을 도착점으로 설정합니다.  
    > c.3) `정방향` 스캔: `시작점 -> 도착점` 방향으로 스캔을 진행합니다.  
    > c.4) `역방향` 스캔: `도착점 -> 시작점` 방향으로 스캔을 진행합니다.  
    > c.5) `엔코더 오프셋 보정`: 스캔 후 탐지된 V홈 엔코더 비트를 기준으로 인코더 오프셋을 진행합니다.  
    > c.6) `엔코더 오프셋으로 이동`: 새롭게 설정된 엔코더 오프셋 위치(V홈)로 이동합니다. 
- 3-d) 마스터링 후 보정된 엔코더 오프셋 수치 제어기에 저장합니다.  
    **!주의! 해당 과정이 생략되면 제어기 재부팅 시 엔코더 오프셋 수치가 사라집니다.**
    > d.1) TP > 엔지니어모드 진입(R: 314) > 2: 시스템 > 3: 로봇 파라미터 > 4: 엔코더 옵셋  
    > d.2) 적용(shift + 확인) 버튼 클릭 후 확인  
      

<br>

**3.1.3.4. 마스터링 후 엔코더 오프셋 보정 여부 확인**
- 엔코더 오프셋은 축 원점과는 독립된 데이터로, `0x400000` 기준으로부터 얼마나 떨어져 있는지를 16진수로 표현한 값입니다. 
- 마스터링은 현재 엔코더 값을 `0x400000` 기준으로 재보정하고 이에 맞춰 `엔코더 오프셋` 값을 갱신하는 작업입니다.
- `3. 마스터링 기반 엔코더 오프셋 보정` 과정을 완료하고 엔코더 오프셋 값들로 이동했을 때 하기 두 가지를 확인하면 됩니다.
    1. `현재 엔코더` 값이 `0x400000` 인지 확인.
    2. `엔코더 오프셋` 값이, `마스터링 된 후의 값`인지 확인.
- 확인 과정    
a.1) TP > 엔지니어모드 진입(R: 314) > 2: 시스템 > 3: 로봇 파라미터 > 4: 엔코더 옵셋  
a.2) `로봇이동` 클릭   
a.3) `보정된 엔코더`의 값들이 `마스터링 된 후의 엔코더 오프셋` 값들인지 확인.  
a.4) 그 때의 현재 엔코더 값이 `0x400000` 값으로 설정되어있는지 확인.


<br>
<br>

### 3.1.4 시험 과정 - 상태 표시 줄 로그
`하나의 축에 대해서` 아래의 (1)~(8)단계를 진행하게 됩니다.
  
|순서|진행 상태 표시|내용|
|:---:|:---:|:---|
|(1)|대기중|처음 app을 실행시켰을 때의 화면|
|(2)|오프셋 포즈로 움직입니다...| `1.인코더 오프셋 이동` 버튼 클릭 시 로봇이 움직이는 상태 |
|(3)|오프셋 포즈에 도달하였습니다.|`1.인코더 오프셋 이동` 정상 수행 완료 상태|
|(4)|마스터링을 시작합니다.|`2.마스터링 시작` 버튼 클릭 시 로봇이 움직이기 시작하는 상태|
|(5)|p1로 가는 중입니다.|`2.마스터링 시작` 버튼 클릭 후 로봇이 p1 방향(시작점에서 +3도)으로 움직이는 상태|
|(6)|p2로 가는 중입니다.|`2.마스터링 시작` 버튼 클릭 후 로봇이 p2 방향(도착점에서 -3도)으로 움직이는 상태|
|(7)|수정된 인코더 오프셋을 적용합니다.|마스터링 완료 후 수정된 원점으로 움직이는 상태|
|(8)|마스터링이 종료되었습니다.|보정된 인코더 오프셋이 보정되고 마스터링이 종료된 상태|

- (1)에서 (8)까지 완료되면 다음 축으로 변경 후 `shift + 확인`을 눌러 축 상태를 저장합니다.
- 변경 된 축 상태 저장을 완료하고, 위의 (2)번부터 (8)까지 수행합니다.
- 모든 축 마스터링이 완료되면, 아래의 과정을 통해 설정된 축들의 엔코더 오프셋 값들을 적용 및 저장.
   - `홈` > `관리자모드 진입(R버튼 + 314)` > `시스템` > `3: 로봇 파라미터` > `4: 엔코더 옵셋` > `shift + 확인` > `확인`

<br>
<br>

### 3.1.5 시험 결과 - 이미지

<div>
<img src="../../_assets/13_standby_kor.png" style="max-height: 30vh; max-width: 35vw">
<img src="../../_assets/14_mastering_end_kor.PNG" style="max-height: 30vh; max-width: 35vw"><br>
Fig 3-1.&nbsp;&nbsp;&nbsp;&nbsp;a.대기 화면(좌측 이미지)
&nbsp;&nbsp;&nbsp;&nbsp;
b. 마스터링 종료 화면(우측 이미지)
</div><br>


`인코더 오프셋(이전/이후)`에는 인코더 오프셋 값(`bit`)이 표기됩니다.
<br> - `왼쪽` 칸 : `마스터링 이전`의 인코더 오프셋 수치
<br> - `오른쪽` 칸 : `마스터링 이후`의 인코더 오프셋 수치

<br>
<br>

### 3.1.6 참고
- 마스터링 결과 값을 인코더 값으로 보여주는 이유
  - 마스터링 결과 비교시, 각도 차이를 보여주는 것이 직관적이나, 0.01 이하의 변화는 TP 상에서 보여주지 않습니다. 
  - 현재 마스터링 과정은 첫 원점에서 -1.5도를 시작점으로 +3도를 도착점으로 미세하게 움직입니다.
  - 이러한 미세 차이를 표현하기 위해서는 bit 단위로 인코더 수치를 보여주는 것이 정확합니다.

